<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveDrive - سلف الموظفين</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/rtl.css">
    <link rel="stylesheet" href="../../assets/css/english-numbers.css">
    <style>
        /* Override global modal styles for this page */
        #advanceModal,
        #installmentsModal {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.6) !important;
            z-index: 99999 !important;
            align-items: center !important;
            justify-content: center !important;
            transform: none !important;
            opacity: 1 !important;
            visibility: visible !important;
            max-width: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }
        #advanceModal.active,
        #installmentsModal.active {
            display: flex !important;
        }
        #advanceModal .modal-content,
        #installmentsModal .modal-content {
            background: var(--bg-card, #1e293b) !important;
            border-radius: 12px !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
            position: relative !important;
            z-index: 100000 !important;
            transform: none !important;
            opacity: 1 !important;
            visibility: visible !important;
            border: 1px solid var(--border-color, #334155) !important;
        }
        #advanceModal .modal-content {
            width: 90% !important;
            max-width: 600px !important;
        }
        #installmentsModal .modal-content {
            width: 90% !important;
            max-width: 800px !important;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color, #334155);
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary, #f8fafc);
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid var(--border-color, #334155);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary, #94a3b8);
        }
        .form-label.required:after {
            content: ' *';
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="page-title">سلف الموظفين</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="showAddAdvanceModal()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        <span>سلفة جديدة</span>
                    </button>
                </div>
            </header>

            <div class="page-content">
                <div class="card mb-6">
                    <div class="card-body">
                        <div class="flex gap-4 flex-wrap">
                            <div class="input-group" style="flex: 1; min-width: 250px;">
                                <span class="input-icon start">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"/>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                    </svg>
                                </span>
                                <input type="search" class="form-input has-icon-start" id="searchInput" placeholder="بحث بالموظف...">
                            </div>
                            <select class="form-select" id="statusFilter" style="width: 180px;">
                                <option value="">كل الحالات</option>
                                <option value="pending">في الانتظار</option>
                                <option value="approved">موافق عليها</option>
                                <option value="paid">مدفوعة</option>
                                <option value="completed">مكتملة</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body" id="advancesContainer">
                        <div class="flex justify-center">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Advance Modal -->
    <div id="advanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">سلفة جديدة</h3>
                <button class="btn btn-icon btn-ghost" onclick="closeAdvanceModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="advanceForm" onsubmit="saveAdvance(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label required">الموظف</label>
                        <select class="form-select" id="employeeId" required>
                            <option value="">-- اختر الموظف --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">المبلغ</label>
                        <input type="number" class="form-input" id="amount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">تاريخ السلفة</label>
                        <input type="date" class="form-input" id="advanceDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">عدد الأقساط</label>
                        <input type="number" class="form-input" id="installmentsCount" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">السبب</label>
                        <textarea class="form-input" id="reason" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAdvanceModal()">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Installments Modal -->
    <div id="installmentsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>الأقساط</h3>
                <button class="btn btn-icon btn-ghost" onclick="closeInstallmentsModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="installmentsContent">
                <div class="flex justify-center">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/utils/numbers.js"></script>
    <script src="../../assets/js/i18n/ar.js"></script>
    <script src="../../assets/js/i18n/en.js"></script>
    <script src="../../assets/js/i18n/i18n.js"></script>
    <script src="../../assets/js/config/supabase.js"></script>
    <script src="../../assets/js/auth/auth.js"></script>
    <script src="../../assets/js/utils/ui.js"></script>
    <script src="../../assets/js/components/sidebar.js"></script>

    <script>
        let allAdvances = [];
        let allEmployees = [];
        let currentAdvanceId = null;

        async function init() {
            i18n.init();
            const { session, user } = await auth.init();
            if (!session) { window.location.href = '../../index.html'; return; }
            Sidebar.render(user);
            
            document.getElementById('advanceDate').value = new Date().toISOString().split('T')[0];
            
            await loadEmployees();
            await loadAdvances();
        }

        async function loadEmployees() {
            // جلب الموظفين النشطين فقط
            const { data, error } = await db
                .from('employees')
                .select('id, name')
                .eq('status', 'active')
                .order('name');
            
            if (error) {
                console.error('Error loading employees:', error);
                return;
            }
            
            allEmployees = data || [];
            
            // إزالة التكرارات بناءً على الاسم (احتياطي في حالة وجود تكرار)
            const uniqueEmployees = [];
            const seenNames = new Map();
            
            allEmployees.forEach(e => {
                if (!seenNames.has(e.name)) {
                    seenNames.set(e.name, e.id);
                    uniqueEmployees.push(e);
                }
            });
            
            const select = document.getElementById('employeeId');
            // مسح الخيارات القديمة والاحتفاظ بالخيار الافتراضي فقط
            select.innerHTML = '<option value="">-- اختر الموظف --</option>';
            
            uniqueEmployees.forEach(e => {
                const option = document.createElement('option');
                option.value = e.id;
                option.textContent = e.name;
                select.appendChild(option);
            });
        }

        async function loadAdvances() {
            const { data, error } = await db
                .from('employee_advances')
                .select('*, employees(id, name)')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Load error:', error);
                return;
            }
            
            allAdvances = data || [];
            renderAdvances(allAdvances);
        }

        function renderAdvances(advances) {
            const container = document.getElementById('advancesContainer');
            
            if (!advances || advances.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💰</div>
                        <h4 class="empty-state-title">لا توجد سلف</h4>
                        <button class="btn btn-primary" onclick="showAddAdvanceModal()">إضافة سلفة جديدة</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>الموظف</th>
                                <th>المبلغ الإجمالي</th>
                                <th>المدفوع</th>
                                <th>المتبقي</th>
                                <th>الأقساط</th>
                                <th>التاريخ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${advances.map(a => {
                                const paidInstallments = a.paid_installments || 0;
                                const totalInstallments = a.installments_count || 1;
                                return `
                                <tr>
                                    <td>${a.employees?.name || '-'}</td>
                                    <td class="font-semibold">${formatCurrency(a.amount)}</td>
                                    <td class="text-success">${formatCurrency(a.paid_amount || 0)}</td>
                                    <td class="text-danger">${formatCurrency(a.remaining_amount || a.amount)}</td>
                                    <td>
                                        <span style="color: var(--success-500); font-weight: 600;">${paidInstallments}</span>
                                        <span style="color: var(--text-muted);">/${totalInstallments}</span>
                                    </td>
                                    <td>${formatDate(a.advance_date)}</td>
                                    <td>${getStatusBadge(a.status)}</td>
                                    <td>
                                        <div class="flex gap-2">
                                            <button class="btn btn-icon btn-ghost btn-sm" onclick="viewInstallments('${a.id}')" title="الأقساط">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                                                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                                                </svg>
                                            </button>
                                            ${a.status === 'pending' ? `
                                                <button class="btn btn-icon btn-success btn-sm" onclick="approveAdvance('${a.id}')" title="موافقة">✓</button>
                                            ` : ''}
                                        </div>
                                    </td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2 }).format(amount || 0) + ' ج.م';
        }

        function formatDate(date) {
            if (!date) return '-';
            return new Date(date).toLocaleDateString('en-GB');
        }

        function getStatusBadge(status) {
            const map = {
                pending: { class: 'badge-warning', text: 'في الانتظار' },
                approved: { class: 'badge-info', text: 'موافق عليها' },
                paid: { class: 'badge-primary', text: 'مدفوعة' },
                completed: { class: 'badge-success', text: 'مكتملة' }
            };
            const s = map[status] || { class: 'badge-gray', text: status };
            return `<span class="badge ${s.class}">${s.text}</span>`;
        }

        function showAddAdvanceModal() {
            console.log('Opening modal...');
            document.getElementById('modalTitle').textContent = 'سلفة جديدة';
            document.getElementById('advanceForm').reset();
            document.getElementById('advanceDate').value = new Date().toISOString().split('T')[0];
            currentAdvanceId = null;
            const modal = document.getElementById('advanceModal');
            modal.classList.add('active');
            console.log('Modal opened');
        }

        function closeAdvanceModal() {
            document.getElementById('advanceModal').classList.remove('active');
        }

        async function saveAdvance(e) {
            e.preventDefault();
            
            const user = auth.getUser();
            const amount = parseFloat(document.getElementById('amount').value);
            const installmentsCount = parseInt(document.getElementById('installmentsCount').value);
            
            const advanceData = {
                employee_id: document.getElementById('employeeId').value,
                amount,
                advance_date: document.getElementById('advanceDate').value,
                reason: document.getElementById('reason').value,
                installments_count: installmentsCount,
                installment_amount: 0, // سيتم تحديده عند الدفع
                remaining_amount: amount,
                paid_amount: 0,
                paid_installments: 0,
                status: 'pending',
                created_by: user?.id
            };

            try {
                const { data: advance, error } = await db
                    .from('employee_advances')
                    .insert(advanceData)
                    .select()
                    .single();

                if (error) throw error;

                // إنشاء سجلات الأقساط (بدون مبلغ محدد)
                const installments = [];
                const startDate = new Date(advanceData.advance_date);
                
                for (let i = 0; i < installmentsCount; i++) {
                    const dueDate = new Date(startDate);
                    dueDate.setMonth(dueDate.getMonth() + i + 1);
                    
                    installments.push({
                        advance_id: advance.id,
                        installment_number: i + 1,
                        amount: 0, // سيتم تحديده عند الدفع
                        due_date: dueDate.toISOString().split('T')[0],
                        status: 'pending'
                    });
                }

                await db.from('advance_installments').insert(installments);

                alert('تم إضافة السلفة بنجاح');
                closeAdvanceModal();
                await loadAdvances();
            } catch (error) {
                console.error('Save error:', error);
                alert('خطأ: ' + error.message);
            }
        }

        async function approveAdvance(id) {
            if (!confirm('هل تريد الموافقة على هذه السلفة؟')) return;
            
            const user = auth.getUser();
            const { error } = await db
                .from('employee_advances')
                .update({
                    status: 'approved',
                    approved_by: user?.id,
                    approved_at: new Date().toISOString()
                })
                .eq('id', id);

            if (error) {
                alert('خطأ: ' + error.message);
                return;
            }

            alert('تمت الموافقة بنجاح');
            await loadAdvances();
        }

        async function viewInstallments(advanceId) {
            currentAdvanceId = advanceId;
            document.getElementById('installmentsModal').classList.add('active');
            
            const { data: installments, error } = await db
                .from('advance_installments')
                .select('*')
                .eq('advance_id', advanceId)
                .order('installment_number');

            if (error) {
                console.error('Load installments error:', error);
                return;
            }

            renderInstallments(installments);
        }

        function renderInstallments(installments) {
            const content = document.getElementById('installmentsContent');
            
            // حساب الإجماليات
            const totalPaid = installments
                .filter(i => i.status === 'paid')
                .reduce((sum, i) => sum + (parseFloat(i.amount) || 0), 0);
            
            const pendingCount = installments.filter(i => i.status === 'pending').length;
            const paidCount = installments.filter(i => i.status === 'paid').length;
            const cancelledCount = installments.filter(i => i.status === 'cancelled').length;
            
            content.innerHTML = `
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">إجمالي المدفوع</div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: var(--success-500);">${formatCurrency(totalPaid)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">الأقساط المدفوعة</div>
                            <div style="font-size: 1.25rem; font-weight: 600;">${paidCount} / ${installments.length}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">الأقساط المتبقية</div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: var(--warning-500);">${pendingCount}</div>
                        </div>
                        ${cancelledCount > 0 ? `
                        <div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">الأقساط الملغاة</div>
                            <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-muted);">${cancelledCount}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>رقم القسط</th>
                                <th>المبلغ المدفوع</th>
                                <th>تاريخ الاستحقاق</th>
                                <th>تاريخ الدفع</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${installments.map(inst => `
                                <tr ${inst.status === 'cancelled' ? 'style="opacity: 0.5;"' : ''}>
                                    <td><strong>#${inst.installment_number}</strong></td>
                                    <td class="font-semibold">${inst.status === 'paid' ? formatCurrency(inst.amount) : '-'}</td>
                                    <td>${formatDate(inst.due_date)}</td>
                                    <td>${inst.paid_date ? formatDate(inst.paid_date) : '-'}</td>
                                    <td>${getInstallmentStatusBadge(inst.status)}</td>
                                    <td>
                                        ${inst.status === 'pending' ? `
                                            <button class="btn btn-success btn-sm" onclick="payInstallment('${inst.id}')">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="20 6 9 17 4 12"/>
                                                </svg>
                                                دفع
                                            </button>
                                        ` : inst.status === 'paid' ? `
                                            <span style="color: var(--success-500); font-size: 0.875rem;">✓ مدفوع</span>
                                        ` : `
                                            <span style="color: var(--text-muted); font-size: 0.875rem;">ملغي</span>
                                        `}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function getInstallmentStatusBadge(status) {
            const map = {
                pending: { class: 'badge-warning', text: 'في الانتظار' },
                paid: { class: 'badge-success', text: 'مدفوع' },
                cancelled: { class: 'badge-gray', text: 'ملغي' }
            };
            const s = map[status] || { class: 'badge-gray', text: status };
            return `<span class="badge ${s.class}">${s.text}</span>`;
        }

        async function payInstallment(installmentId) {
            // فتح نافذة لإدخال المبلغ المدفوع
            const installment = await getInstallmentDetails(installmentId);
            if (!installment) return;
            
            const advance = await getAdvanceDetails(installment.advance_id);
            if (!advance) return;
            
            const remainingAmount = advance.remaining_amount || advance.amount;
            
            // التحقق من أن المبلغ لم يكتمل بعد
            if (remainingAmount <= 0) {
                alert('تم دفع السلفة بالكامل! لا يوجد مبلغ متبقي.');
                await viewInstallments(currentAdvanceId);
                return;
            }
            
            const paidInstallments = advance.paid_installments || 0;
            const remainingInstallments = advance.installments_count - paidInstallments;
            
            // التحقق من عدد الأقساط المتبقية
            if (remainingInstallments <= 0) {
                alert('تم استخدام جميع الأقساط المتاحة!');
                await viewInstallments(currentAdvanceId);
                return;
            }
            
            const amountToPay = prompt(
                `المبلغ المتبقي: ${formatCurrency(remainingAmount)}\n` +
                `عدد الأقساط المتبقية: ${remainingInstallments}\n\n` +
                `أدخل المبلغ المراد دفعه:`
            );
            
            if (!amountToPay) return;
            
            const amount = parseFloat(amountToPay);
            
            // التحقق من صحة المبلغ
            if (isNaN(amount) || amount <= 0) {
                alert('الرجاء إدخال مبلغ صحيح');
                return;
            }
            
            if (amount > remainingAmount) {
                alert(`المبلغ المدخل أكبر من المتبقي (${formatCurrency(remainingAmount)})`);
                return;
            }
            
            if (!confirm(`هل تريد تسجيل دفع ${formatCurrency(amount)}؟`)) return;
            
            const user = auth.getUser();
            
            try {
                // تحديث القسط الحالي
                const { error: installmentError } = await db
                    .from('advance_installments')
                    .update({
                        status: 'paid',
                        amount: amount,
                        paid_date: new Date().toISOString().split('T')[0],
                        paid_by: user?.id
                    })
                    .eq('id', installmentId);

                if (installmentError) throw installmentError;

                // حساب المبلغ المتبقي الجديد
                const newRemainingAmount = Math.max(0, remainingAmount - amount);
                const newPaidAmount = (advance.paid_amount || 0) + amount;
                const newPaidInstallments = paidInstallments + 1;
                
                // تحديد الحالة الجديدة
                let newStatus = advance.status;
                if (newRemainingAmount <= 0) {
                    newStatus = 'completed';
                    // إلغاء جميع الأقساط المتبقية
                    await db
                        .from('advance_installments')
                        .update({ status: 'cancelled' })
                        .eq('advance_id', advance.id)
                        .eq('status', 'pending');
                } else if (advance.status === 'pending') {
                    newStatus = 'approved';
                } else if (newPaidInstallments > 0) {
                    newStatus = 'paid';
                }

                // تحديث السلفة
                const { error: advanceError } = await db
                    .from('employee_advances')
                    .update({
                        paid_amount: newPaidAmount,
                        remaining_amount: newRemainingAmount,
                        paid_installments: newPaidInstallments,
                        status: newStatus
                    })
                    .eq('id', advance.id);

                if (advanceError) throw advanceError;

                // رسالة مختلفة حسب الحالة
                if (newRemainingAmount <= 0) {
                    alert(
                        `✓ تم إكمال السلفة بنجاح!\n\n` +
                        `المبلغ المدفوع: ${formatCurrency(amount)}\n` +
                        `إجمالي المدفوع: ${formatCurrency(newPaidAmount)}\n` +
                        `تم سداد السلفة بالكامل`
                    );
                } else {
                    alert(
                        `تم تسجيل الدفع بنجاح\n\n` +
                        `المبلغ المدفوع: ${formatCurrency(amount)}\n` +
                        `المتبقي: ${formatCurrency(newRemainingAmount)}\n` +
                        `الأقساط المتبقية: ${advance.installments_count - newPaidInstallments}`
                    );
                }
                
                await viewInstallments(currentAdvanceId);
                await loadAdvances();
            } catch (error) {
                console.error('Payment error:', error);
                alert('خطأ: ' + error.message);
            }
        }

        async function getInstallmentDetails(installmentId) {
            const { data, error } = await db
                .from('advance_installments')
                .select('*')
                .eq('id', installmentId)
                .single();
            
            if (error) {
                console.error('Error loading installment:', error);
                return null;
            }
            return data;
        }

        async function getAdvanceDetails(advanceId) {
            const { data, error } = await db
                .from('employee_advances')
                .select('*')
                .eq('id', advanceId)
                .single();
            
            if (error) {
                console.error('Error loading advance:', error);
                return null;
            }
            return data;
        }

        function closeInstallmentsModal() {
            document.getElementById('installmentsModal').classList.remove('active');
        }

        document.getElementById('searchInput').addEventListener('input', () => {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allAdvances.filter(a => 
                a.employees?.name?.toLowerCase().includes(search)
            );
            renderAdvances(filtered);
        });

        document.getElementById('statusFilter').addEventListener('change', () => {
            const status = document.getElementById('statusFilter').value;
            const filtered = status ? allAdvances.filter(a => a.status === status) : allAdvances;
            renderAdvances(filtered);
        });

        init();
    </script>
</body>
</html>
