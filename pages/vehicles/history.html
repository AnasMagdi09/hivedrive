<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveDrive - Ø³Ø¬Ù„ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/rtl.css">
    <style>
        .vehicle-header { background: linear-gradient(135deg, var(--bg-card), var(--bg-tertiary)); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; display: flex; gap: 2rem; align-items: center; }
        .vehicle-icon { width: 100px; height: 100px; background: var(--accent); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        .vehicle-info h2 { font-size: 1.5rem; color: var(--text-primary); margin-bottom: 0.5rem; }
        .vehicle-info .plate { font-size: 1.25rem; color: var(--accent); font-weight: 600; }
        .vehicle-meta { display: flex; gap: 2rem; margin-top: 1rem; flex-wrap: wrap; }
        .vehicle-meta-item { display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); }
        
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-box { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; text-align: center; border: 1px solid var(--border-color); }
        .stat-box .value { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .stat-box .label { font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .stat-box.success .value { color: #10b981; }
        .stat-box.warning .value { color: #f59e0b; }
        
        .timeline { position: relative; padding-right: 2rem; }
        .timeline::before { content: ''; position: absolute; right: 0.5rem; top: 0; bottom: 0; width: 2px; background: var(--border-color); }
        .timeline-item { position: relative; padding-bottom: 2rem; }
        .timeline-item:last-child { padding-bottom: 0; }
        .timeline-dot { position: absolute; right: -1.5rem; top: 0.25rem; width: 1rem; height: 1rem; border-radius: 50%; background: var(--accent); border: 3px solid var(--bg-primary); }
        .timeline-dot.completed { background: #10b981; }
        .timeline-dot.pending { background: #f59e0b; }
        .timeline-content { background: var(--bg-card); border-radius: 12px; padding: 1.25rem; border: 1px solid var(--border-color); }
        .timeline-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem; }
        .timeline-title { font-weight: 600; color: var(--text-primary); }
        .timeline-date { font-size: 0.875rem; color: var(--text-muted); }
        .timeline-details { font-size: 0.875rem; color: var(--text-secondary); }
        .timeline-items { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color); }
        .timeline-items li { padding: 0.25rem 0; display: flex; justify-content: space-between; }
        
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .tab-btn { padding: 0.75rem 1.5rem; border: none; background: transparent; border-radius: 8px 8px 0 0; cursor: pointer; font-family: inherit; font-weight: 500; color: var(--text-secondary); transition: all 0.2s; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-btn:hover:not(.active) { background: var(--bg-tertiary); }
        
        @media (max-width: 768px) {
            .vehicle-header { flex-direction: column; text-align: center; }
            .vehicle-meta { justify-content: center; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="btn btn-icon btn-ghost" onclick="history.back()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                    </button>
                    <h1 class="page-title">Ø³Ø¬Ù„ ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„</button>
                </div>
            </header>

            <div class="page-content">
                <!-- Vehicle Header -->
                <div class="vehicle-header" id="vehicleHeader">
                    <div class="vehicle-icon">ğŸš—</div>
                    <div class="vehicle-info">
                        <h2 id="vehicleName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
                        <div class="plate" id="vehiclePlate">---</div>
                        <div class="vehicle-meta">
                            <div class="vehicle-meta-item">ğŸ‘¤ <span id="ownerName">-</span></div>
                            <div class="vehicle-meta-item">ğŸ“… <span id="vehicleYear">-</span></div>
                            <div class="vehicle-meta-item">ğŸ¨ <span id="vehicleColor">-</span></div>
                            <div class="vehicle-meta-item">ğŸ“ <span id="vehicleMileage">- ÙƒÙ…</span></div>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="value" id="totalVisits">0</div>
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                    </div>
                    <div class="stat-box success">
                        <div class="value" id="totalSpent">0 Ø¬.Ù…</div>
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                    </div>
                    <div class="stat-box warning">
                        <div class="value" id="lastVisit">-</div>
                        <div class="label">Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="avgInterval">-</div>
                        <div class="label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØªØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="showTab('all')">ğŸ“‹ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
                    <button class="tab-btn" onclick="showTab('workorders')">ğŸ”§ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„</button>
                    <button class="tab-btn" onclick="showTab('quotations')">ğŸ“ Ø§Ù„Ù…Ù‚Ø§ÙŠØ³Ø§Øª</button>
                    <button class="tab-btn" onclick="showTab('invoices')">ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
                </div>

                <!-- Timeline -->
                <div class="card">
                    <div class="card-body">
                        <div class="timeline" id="historyTimeline">
                            <div class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/i18n/ar.js"></script>
    <script src="../../assets/js/i18n/en.js"></script>
    <script src="../../assets/js/i18n/i18n.js"></script>
    <script src="../../assets/js/config/supabase.js"></script>
    <script src="../../assets/js/auth/auth.js"></script>
    <script src="../../assets/js/utils/ui.js"></script>
    <script src="../../assets/js/components/sidebar.js"></script>

    <script>
        let vehicleId = null;
        let allRecords = [];
        let currentTab = 'all';

        async function init() {
            i18n.init();
            const { session, user } = await auth.init();
            if (!session) { window.location.href = '../../index.html'; return; }
            Sidebar.render(user);

            vehicleId = new URLSearchParams(window.location.search).get('id');
            if (!vehicleId) {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©');
                history.back();
                return;
            }

            await loadVehicleInfo();
            await loadHistory();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG').format(amount || 0) + ' Ø¬.Ù…';
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        async function loadVehicleInfo() {
            try {
                const { data, error } = await db.from('vehicles')
                    .select('*, customers(name, phone)')
                    .eq('id', vehicleId)
                    .single();

                if (error) throw error;

                document.getElementById('vehicleName').textContent = `${data.brand} ${data.model || ''}`;
                document.getElementById('vehiclePlate').textContent = data.plate_number;
                document.getElementById('ownerName').textContent = data.customers?.name || '-';
                document.getElementById('vehicleYear').textContent = data.year || '-';
                document.getElementById('vehicleColor').textContent = data.color || '-';
                document.getElementById('vehicleMileage').textContent = data.mileage ? `${data.mileage.toLocaleString()} ÙƒÙ…` : '- ÙƒÙ…';

            } catch (error) {
                console.error('Vehicle info error:', error);
            }
        }

        async function loadHistory() {
            try {
                // Load work orders
                const { data: workOrders } = await db.from('work_orders')
                    .select('*, work_order_items(*)')
                    .eq('vehicle_id', vehicleId)
                    .order('created_at', { ascending: false });

                // Load quotations
                const { data: quotations } = await db.from('quotations')
                    .select('*, quotation_items(*)')
                    .eq('vehicle_id', vehicleId)
                    .order('created_at', { ascending: false });

                // Load invoices via work orders
                const woIds = (workOrders || []).map(wo => wo.id);
                let invoices = [];
                if (woIds.length > 0) {
                    const { data: invData } = await db.from('invoices')
                        .select('*')
                        .in('work_order_id', woIds)
                        .order('created_at', { ascending: false });
                    invoices = invData || [];
                }

                // Combine all records
                allRecords = [
                    ...(workOrders || []).map(wo => ({ ...wo, type: 'workorder' })),
                    ...(quotations || []).map(q => ({ ...q, type: 'quotation' })),
                    ...invoices.map(inv => ({ ...inv, type: 'invoice' }))
                ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                // Calculate stats
                const totalVisits = (workOrders || []).length;
                const totalSpent = invoices.reduce((sum, inv) => sum + (inv.paid_amount || 0), 0);
                const lastVisitDate = allRecords.length > 0 ? allRecords[0].created_at : null;

                document.getElementById('totalVisits').textContent = totalVisits;
                document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
                document.getElementById('lastVisit').textContent = lastVisitDate ? formatDate(lastVisitDate) : '-';

                // Calculate average interval
                if (workOrders && workOrders.length > 1) {
                    const dates = workOrders.map(wo => new Date(wo.created_at)).sort((a, b) => a - b);
                    let totalDays = 0;
                    for (let i = 1; i < dates.length; i++) {
                        totalDays += (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
                    }
                    const avgDays = Math.round(totalDays / (dates.length - 1));
                    document.getElementById('avgInterval').textContent = `${avgDays} ÙŠÙˆÙ…`;
                }

                renderTimeline();

            } catch (error) {
                console.error('History error:', error);
            }
        }

        function showTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderTimeline();
        }

        function renderTimeline() {
            let records = allRecords;
            if (currentTab !== 'all') {
                const typeMap = { workorders: 'workorder', quotations: 'quotation', invoices: 'invoice' };
                records = allRecords.filter(r => r.type === typeMap[currentTab]);
            }

            const container = document.getElementById('historyTimeline');
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>';
                return;
            }

            const statusMap = {
                pending: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
                in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
                completed: 'Ù…ÙƒØªÙ…Ù„',
                delivered: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…',
                draft: 'Ù…Ø³ÙˆØ¯Ø©',
                approved: 'Ù…Ø¹ØªÙ…Ø¯',
                converted: 'ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„',
                issued: 'ØµØ§Ø¯Ø±Ø©',
                paid: 'Ù…Ø¯ÙÙˆØ¹Ø©',
                partial: 'Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø²Ø¦ÙŠØ§Ù‹'
            };

            const typeIcons = {
                workorder: 'ğŸ”§',
                quotation: 'ğŸ“',
                invoice: 'ğŸ§¾'
            };

            const typeNames = {
                workorder: 'Ø£Ù…Ø± Ø´ØºÙ„',
                quotation: 'Ù…Ù‚Ø§ÙŠØ³Ø©',
                invoice: 'ÙØ§ØªÙˆØ±Ø©'
            };

            container.innerHTML = records.map(record => {
                const items = record.work_order_items || record.quotation_items || [];
                const number = record.order_number || record.quotation_number || record.invoice_number;
                const dotClass = ['completed', 'delivered', 'paid'].includes(record.status) ? 'completed' : 
                               ['pending', 'draft'].includes(record.status) ? 'pending' : '';

                return `
                    <div class="timeline-item">
                        <div class="timeline-dot ${dotClass}"></div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <div>
                                    <span class="timeline-title">${typeIcons[record.type]} ${typeNames[record.type]} - ${number}</span>
                                    <span class="badge badge-sm mr-2">${statusMap[record.status] || record.status}</span>
                                </div>
                                <span class="timeline-date">${formatDate(record.created_at)}</span>
                            </div>
                            <div class="timeline-details">
                                Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong>${formatCurrency(record.total)}</strong>
                                ${record.type === 'invoice' ? ` | Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <strong class="text-success">${formatCurrency(record.paid_amount)}</strong>` : ''}
                            </div>
                            ${items.length > 0 ? `
                                <ul class="timeline-items">
                                    ${items.slice(0, 5).map(item => `
                                        <li>
                                            <span>${item.description}</span>
                                            <span>${formatCurrency(item.total)}</span>
                                        </li>
                                    `).join('')}
                                    ${items.length > 5 ? `<li class="text-muted">... Ùˆ ${items.length - 5} Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰</li>` : ''}
                                </ul>
                            ` : ''}
                            <div class="mt-3">
                                <a href="../${record.type === 'workorder' ? 'workorders' : record.type === 'quotation' ? 'quotations' : 'invoices'}/view.html?id=${record.id}" class="btn btn-sm btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ â†’</a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        init();
    </script>
</body>

</html>
