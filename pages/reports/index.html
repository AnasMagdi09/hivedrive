<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveDrive - Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/rtl.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .reports-header { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; align-items: center; }
        .date-range { display: flex; gap: 0.5rem; align-items: center; color: var(--text-primary); }
        .date-range input { padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit; background: var(--bg-input); color: var(--text-primary); }
        
        .report-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .report-card { background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); text-align: center; }
        .report-card .value { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); }
        .report-card .label { color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.25rem; }
        .report-card.success .value { color: #10b981; }
        .report-card.danger .value { color: #ef4444; }
        .report-card.info .value { color: #3b82f6; }
        
        .charts-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .chart-box { background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); }
        .chart-box h3 { margin-bottom: 1rem; font-size: 1rem; color: var(--text-primary); }
        .chart-container { height: 300px; position: relative; }
        
        .data-table { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; margin-bottom: 1.5rem; }
        .data-table-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .data-table-header h3 { color: var(--text-primary); margin: 0; }
        .data-table table { width: 100%; border-collapse: collapse; }
        .data-table th { background: var(--bg-tertiary); padding: 1rem; text-align: right; font-weight: 600; color: var(--text-primary); }
        .data-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        .data-table tr:hover { background: var(--bg-tertiary); }
        
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .tab-btn { padding: 0.75rem 1.5rem; border: none; background: var(--bg-card); border-radius: 8px; cursor: pointer; font-family: inherit; font-weight: 500; transition: all 0.2s; color: var(--text-primary); border: 1px solid var(--border-color); }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .tab-btn:hover:not(.active) { background: var(--bg-tertiary); }
        
        @media (max-width: 1024px) {
            .report-cards { grid-template-columns: repeat(2, 1fr); }
            .charts-section { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .report-cards { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="header" id="header">
                <div class="header-left">
                    <button class="btn btn-icon btn-ghost" id="mobileMenuBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                    <h1 class="page-title">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-secondary" onclick="exportReport()">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                    <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                </div>
            </header>

            <div class="page-content">
                <!-- Date Range Filter -->
                <div class="reports-header">
                    <div class="date-range">
                        <label>Ù…Ù†:</label>
                        <input type="date" id="dateFrom">
                        <label>Ø¥Ù„Ù‰:</label>
                        <input type="date" id="dateTo">
                        <button class="btn btn-primary" onclick="loadReports()">ØªØ­Ø¯ÙŠØ«</button>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn" onclick="setPreset('today', this)">Ø§Ù„ÙŠÙˆÙ…</button>
                        <button class="tab-btn" onclick="setPreset('week', this)">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
                        <button class="tab-btn active" onclick="setPreset('month', this)">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</button>
                        <button class="tab-btn" onclick="setPreset('year', this)">Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="report-cards">
                    <div class="report-card success">
                        <div class="value" id="totalRevenue">0</div>
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                    </div>
                    <div class="report-card danger">
                        <div class="value" id="totalExpenses">0</div>
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
                    </div>
                    <div class="report-card info">
                        <div class="value" id="netProfit">0</div>
                        <div class="label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
                    </div>
                    <div class="report-card">
                        <div class="value" id="totalWorkOrders">0</div>
                        <div class="label">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„</div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-section">
                    <div class="chart-box">
                        <h3>ğŸ“ˆ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                        <div class="chart-container">
                            <canvas id="revenueExpenseChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h3>ğŸ”§ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
                        <div class="chart-container">
                            <canvas id="workOrdersStatusChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h3>ğŸ† Ø£ÙƒØ«Ø± Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø·Ù„Ø¨Ø§Ù‹</h3>
                        <div class="chart-container">
                            <canvas id="topServicesChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h3>ğŸ‘¥ Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                        <div class="chart-container">
                            <canvas id="topCustomersChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Tables -->
                <div class="data-table mb-6">
                    <div class="data-table-header">
                        <h3>ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                            </tr>
                        </thead>
                        <tbody id="revenueTable">
                            <tr><td colspan="5" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="data-table">
                    <div class="data-table-header">
                        <h3>ğŸ“‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th>Ø§Ù„ÙˆØµÙ</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTable">
                            <tr><td colspan="4" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/i18n/ar.js"></script>
    <script src="../../assets/js/i18n/en.js"></script>
    <script src="../../assets/js/i18n/i18n.js"></script>
    <script src="../../assets/js/config/supabase.js"></script>
    <script src="../../assets/js/auth/auth.js"></script>
    <script src="../../assets/js/utils/ui.js"></script>
    <script src="../../assets/js/components/sidebar.js"></script>

    <script>
        let charts = {};

        async function init() {
            i18n.init();
            const { session, user } = await auth.init();
            if (!session) { window.location.href = '../../index.html'; return; }
            Sidebar.render(user);
            
            // Set default dates (this month)
            setPreset('month');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG').format(amount || 0) + ' Ø¬.Ù…';
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('ar-EG');
        }

        function setPreset(preset, btn) {
            const today = new Date();
            let from, to = today.toISOString().split('T')[0];
            
            switch(preset) {
                case 'today':
                    from = to;
                    break;
                case 'week':
                    from = new Date(today - 7 * 86400000).toISOString().split('T')[0];
                    break;
                case 'month':
                    from = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    break;
                case 'year':
                    from = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('dateFrom').value = from;
            document.getElementById('dateTo').value = to;
            
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (btn) {
                btn.classList.add('active');
            } else {
                // Default to month tab when called from init
                document.querySelector('.tab-btn:nth-child(3)')?.classList.add('active');
            }
            
            loadReports();
        }

        async function loadReports() {
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;
            
            await Promise.all([
                loadSummary(from, to),
                loadRevenueExpenseChart(from, to),
                loadWorkOrdersChart(from, to),
                loadTopServices(from, to),
                loadTopCustomers(from, to),
                loadRevenueTable(from, to),
                loadExpensesTable(from, to)
            ]);
        }

        async function loadSummary(from, to) {
            try {
                // Total Revenue
                const { data: payments } = await db.from('payments').select('amount').gte('payment_date', from).lte('payment_date', to);
                const totalRevenue = (payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

                // Total Expenses
                const { data: expenses } = await db.from('expenses').select('amount').gte('expense_date', from).lte('expense_date', to);
                const { data: treasuryExp } = await db.from('treasury_transactions').select('amount').eq('transaction_type', 'expense').gte('transaction_date', from).lte('transaction_date', to);
                const totalExpenses = (expenses || []).reduce((sum, e) => sum + (e.amount || 0), 0) + (treasuryExp || []).reduce((sum, e) => sum + (e.amount || 0), 0);
                document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);

                // Net Profit
                const netProfit = totalRevenue - totalExpenses;
                document.getElementById('netProfit').textContent = formatCurrency(netProfit);
                document.getElementById('netProfit').parentElement.className = 'report-card ' + (netProfit >= 0 ? 'success' : 'danger');

                // Work Orders
                const { count } = await db.from('work_orders').select('*', { count: 'exact', head: true }).gte('created_at', from).lte('created_at', to + 'T23:59:59');
                document.getElementById('totalWorkOrders').textContent = count || 0;

            } catch (error) {
                console.error('Summary error:', error);
            }
        }

        async function loadRevenueExpenseChart(from, to) {
            // Generate daily data
            const days = [];
            const revenues = [];
            const expenses = [];
            
            const start = new Date(from);
            const end = new Date(to);
            const diffDays = Math.ceil((end - start) / 86400000) + 1;
            
            // Limit to 30 days for readability
            const step = diffDays > 30 ? Math.ceil(diffDays / 30) : 1;
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + step)) {
                const dateStr = d.toISOString().split('T')[0];
                days.push(d.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' }));
                
                const { data: dayPayments } = await db.from('payments').select('amount').eq('payment_date', dateStr);
                revenues.push((dayPayments || []).reduce((sum, p) => sum + (p.amount || 0), 0));
                
                const { data: dayExpenses } = await db.from('treasury_transactions').select('amount').eq('transaction_type', 'expense').eq('transaction_date', dateStr);
                expenses.push((dayExpenses || []).reduce((sum, e) => sum + (e.amount || 0), 0));
            }

            if (charts.revenueExpense) charts.revenueExpense.destroy();
            
            const ctx = document.getElementById('revenueExpenseChart').getContext('2d');
            charts.revenueExpense = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [
                        { label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', data: revenues, backgroundColor: '#10b981' },
                        { label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª', data: expenses, backgroundColor: '#ef4444' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'top',
                            labels: { color: '#f8fafc' }
                        } 
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        async function loadWorkOrdersChart(from, to) {
            const statuses = [
                { key: 'pending', label: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', color: '#f59e0b' },
                { key: 'in_progress', label: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', color: '#3b82f6' },
                { key: 'completed', label: 'Ù…ÙƒØªÙ…Ù„', color: '#10b981' },
                { key: 'delivered', label: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', color: '#6b7280' }
            ];

            const data = [];
            for (const s of statuses) {
                const { count } = await db.from('work_orders').select('*', { count: 'exact', head: true }).eq('status', s.key).gte('created_at', from).lte('created_at', to + 'T23:59:59');
                data.push(count || 0);
            }

            if (charts.workOrders) charts.workOrders.destroy();
            
            const ctx = document.getElementById('workOrdersStatusChart').getContext('2d');
            charts.workOrders = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: statuses.map(s => s.label),
                    datasets: [{ data, backgroundColor: statuses.map(s => s.color) }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'right',
                            labels: { color: '#f8fafc' }
                        } 
                    }
                }
            });
        }

        async function loadTopServices(from, to) {
            try {
                const { data } = await db.from('work_order_items').select('description, total').eq('item_type', 'service').gte('created_at', from).lte('created_at', to + 'T23:59:59');
                
                // Group by description
                const grouped = {};
                (data || []).forEach(item => {
                    const key = item.description || 'Ø£Ø®Ø±Ù‰';
                    grouped[key] = (grouped[key] || 0) + (item.total || 0);
                });
                
                const sorted = Object.entries(grouped).sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                if (charts.topServices) charts.topServices.destroy();
                
                const ctx = document.getElementById('topServicesChart').getContext('2d');
                charts.topServices = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(s => s[0].substring(0, 20)),
                        datasets: [{ label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', data: sorted.map(s => s[1]), backgroundColor: '#f59e0b' }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Top services error:', error);
            }
        }

        async function loadTopCustomers(from, to) {
            try {
                const { data } = await db.from('invoices').select('total, customers(name)').gte('created_at', from).lte('created_at', to + 'T23:59:59');
                
                // Group by customer
                const grouped = {};
                (data || []).forEach(inv => {
                    const key = inv.customers?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    grouped[key] = (grouped[key] || 0) + (inv.total || 0);
                });
                
                const sorted = Object.entries(grouped).sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                if (charts.topCustomers) charts.topCustomers.destroy();
                
                const ctx = document.getElementById('topCustomersChart').getContext('2d');
                charts.topCustomers = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(s => s[0]),
                        datasets: [{ label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±', data: sorted.map(s => s[1]), backgroundColor: '#3b82f6' }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Top customers error:', error);
            }
        }

        async function loadRevenueTable(from, to) {
            try {
                const { data } = await db.from('payments').select('*, invoices(invoice_number, customers(name))').gte('payment_date', from).lte('payment_date', to).order('payment_date', { ascending: false }).limit(20);
                
                const tbody = document.getElementById('revenueTable');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    return;
                }

                const methodMap = { cash: 'Ù†Ù‚Ø¯ÙŠ', bank_transfer: 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ', credit_card: 'Ø¨Ø·Ø§Ù‚Ø©' };
                tbody.innerHTML = data.map(p => `
                    <tr>
                        <td>${formatDate(p.payment_date)}</td>
                        <td>${p.invoices?.invoice_number || '-'}</td>
                        <td>${p.invoices?.customers?.name || '-'}</td>
                        <td class="text-success font-semibold">${formatCurrency(p.amount)}</td>
                        <td>${methodMap[p.payment_method] || p.payment_method}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Revenue table error:', error);
            }
        }

        async function loadExpensesTable(from, to) {
            try {
                const { data } = await db.from('treasury_transactions').select('*').eq('transaction_type', 'expense').gte('transaction_date', from).lte('transaction_date', to).order('transaction_date', { ascending: false }).limit(20);
                
                const tbody = document.getElementById('expensesTable');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(e => `
                    <tr>
                        <td>${formatDate(e.transaction_date)}</td>
                        <td>${e.category || '-'}</td>
                        <td>${e.description || '-'}</td>
                        <td class="text-danger font-semibold">${formatCurrency(e.amount)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Expenses table error:', error);
            }
        }

        function exportReport() {
            // Simple CSV export
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;
            alert(`Ø³ÙŠØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to}\n\nÙ‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±`);
        }

        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });

        init();
    </script>
</body>

</html>
