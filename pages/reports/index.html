<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveDrive - Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/main.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/rtl.css">
</head>

<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="header" id="header">
                <div class="header-left">
                    <button class="btn btn-icon btn-ghost" id="mobileMenuBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12" />
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                    <h1 class="page-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h1>
                </div>
            </header>

            <div class="page-content">
                <!-- Period Selector -->
                <div class="card mb-6">
                    <div class="card-body">
                        <div class="flex gap-4 flex-wrap items-center">
                            <label class="form-label" style="margin: 0;">Ø§Ù„ÙØªØ±Ø©:</label>
                            <select class="form-select" id="periodSelect" style="width: 180px;">
                                <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                                <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                                <option value="month" selected>Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                                <option value="year">Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…</option>
                            </select>
                            <div class="flex gap-2">
                                <input type="date" class="form-input" id="dateFrom" style="width: 150px;">
                                <span>Ø¥Ù„Ù‰</span>
                                <input type="date" class="form-input" id="dateTo" style="width: 150px;">
                            </div>
                            <button class="btn btn-primary" onclick="loadReports()">ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="grid grid-cols-4 mb-6">
                    <div class="stat-card">
                        <div class="stat-icon success">ğŸ’°</div>
                        <div class="stat-content">
                            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</span>
                            <span class="stat-value text-success" id="totalRevenue">0 Ø¬.Ù…</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">ğŸ“‰</div>
                        <div class="stat-content">
                            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>
                            <span class="stat-value text-danger" id="totalExpenses">0 Ø¬.Ù…</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon primary">ğŸ“Š</div>
                        <div class="stat-content">
                            <span class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</span>
                            <span class="stat-value" id="netProfit">0 Ø¬.Ù…</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">ğŸ”§</div>
                        <div class="stat-content">
                            <span class="stat-label">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„</span>
                            <span class="stat-value" id="totalWorkOrders">0</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <!-- Work Orders by Status -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
                        </div>
                        <div class="card-body" id="woByStatus">
                            <div class="flex justify-center">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Customers -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Ø£ÙØ¶Ù„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                        </div>
                        <div class="card-body" id="topCustomers">
                            <div class="flex justify-center">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue by Category -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
                        </div>
                        <div class="card-body" id="revenueByCategory">
                            <div class="flex justify-center">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Alert -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
                        </div>
                        <div class="card-body" id="lowStockAlert">
                            <div class="flex justify-center">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/i18n/ar.js"></script>
    <script src="../../assets/js/i18n/en.js"></script>
    <script src="../../assets/js/i18n/i18n.js"></script>
    <script src="../../assets/js/config/supabase.js"></script>
    <script src="../../assets/js/auth/auth.js"></script>
    <script src="../../assets/js/utils/ui.js"></script>
    <script src="../../assets/js/utils/api.js"></script>
    <script src="../../assets/js/components/sidebar.js"></script>

    <script>
        async function init() {
            i18n.init();
            const { session, user } = await auth.init();
            if (!session) { window.location.href = '../../index.html'; return; }
            Sidebar.render(user);

            // Set default dates
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];

            await loadReports();
        }

        async function loadReports() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            // Load revenue
            const { data: payments } = await db.from('payments').select('amount').gte('payment_date', dateFrom).lte('payment_date', dateTo);
            const totalRevenue = (payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
            document.getElementById('totalRevenue').textContent = UI.formatCurrency(totalRevenue);

            // Load expenses
            const { data: expenses } = await db.from('expenses').select('amount').gte('expense_date', dateFrom).lte('expense_date', dateTo);
            const totalExpenses = (expenses || []).reduce((sum, e) => sum + (e.amount || 0), 0);
            document.getElementById('totalExpenses').textContent = UI.formatCurrency(totalExpenses);

            // Net profit
            const netProfit = totalRevenue - totalExpenses;
            document.getElementById('netProfit').textContent = UI.formatCurrency(netProfit);
            document.getElementById('netProfit').className = 'stat-value ' + (netProfit >= 0 ? 'text-success' : 'text-danger');

            // Work orders count
            const { count: woCount } = await db.from('work_orders').select('*', { count: 'exact', head: true }).gte('created_at', dateFrom).lte('created_at', dateTo + 'T23:59:59');
            document.getElementById('totalWorkOrders').textContent = woCount || 0;

            // WO by Status
            await loadWOByStatus(dateFrom, dateTo);

            // Top Customers
            await loadTopCustomers();

            // Low Stock
            await loadLowStock();
        }

        async function loadWOByStatus(dateFrom, dateTo) {
            const statuses = ['pending', 'in_progress', 'completed', 'delivered', 'cancelled'];
            const container = document.getElementById('woByStatus');
            let html = '';

            for (const status of statuses) {
                const { count } = await db.from('work_orders').select('*', { count: 'exact', head: true })
                    .eq('status', status)
                    .gte('created_at', dateFrom)
                    .lte('created_at', dateTo + 'T23:59:59');

                const labels = { pending: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', completed: 'Ù…ÙƒØªÙ…Ù„', delivered: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', cancelled: 'Ù…Ù„ØºÙŠ' };
                const colors = { pending: 'warning', in_progress: 'primary', completed: 'success', delivered: 'success', cancelled: 'danger' };

                html += `
                    <div class="flex justify-between items-center py-2 border-b">
                        <span class="badge badge-${colors[status]}">${labels[status]}</span>
                        <span class="font-semibold">${count || 0}</span>
                    </div>
                `;
            }
            container.innerHTML = html || '<p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
        }

        async function loadTopCustomers() {
            const { data: customers } = await db.from('customers').select('id, name, total_spent').order('total_spent', { ascending: false }).limit(5);
            const container = document.getElementById('topCustomers');

            if (!customers || customers.length === 0) {
                container.innerHTML = '<p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
                return;
            }

            container.innerHTML = customers.map((c, i) => `
                <div class="flex justify-between items-center py-2 border-b">
                    <div class="flex items-center gap-3">
                        <span class="badge badge-gray">${i + 1}</span>
                        <span>${c.name}</span>
                    </div>
                    <span class="font-semibold text-success">${UI.formatCurrency(c.total_spent || 0)}</span>
                </div>
            `).join('');
        }

        async function loadLowStock() {
            const { data: parts } = await db.from('inventory').select('quantity, parts(name, sku, min_quantity)').lt('quantity', 5).limit(5);
            const container = document.getElementById('lowStockAlert');

            if (!parts || parts.length === 0) {
                container.innerHTML = '<p class="text-success">âœ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…ØªÙˆÙØ±Ø©</p>';
                return;
            }

            container.innerHTML = parts.map(p => `
                <div class="flex justify-between items-center py-2 border-b">
                    <div>
                        <span class="font-medium">${p.parts?.name || '-'}</span>
                        <span class="text-muted text-sm"> (${p.parts?.sku})</span>
                    </div>
                    <span class="badge badge-danger">${p.quantity} Ù…ØªØ¨Ù‚ÙŠ</span>
                </div>
            `).join('');
        }

        document.getElementById('periodSelect').addEventListener('change', function () {
            const today = new Date();
            let from, to = today;

            switch (this.value) {
                case 'today':
                    from = today; break;
                case 'week':
                    from = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case 'month':
                    from = new Date(today.getFullYear(), today.getMonth(), 1); break;
                case 'year':
                    from = new Date(today.getFullYear(), 0, 1); break;
            }

            document.getElementById('dateFrom').value = from.toISOString().split('T')[0];
            document.getElementById('dateTo').value = to.toISOString().split('T')[0];
        });

        init();
    </script>
</body>

</html>