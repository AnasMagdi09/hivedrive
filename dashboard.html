<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveDrive - لوحة التحكم</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/variables.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/rtl.css">
    <link rel="stylesheet" href="assets/css/english-numbers.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card-lg { background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card-lg:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .stat-card-lg .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; }
        .stat-card-lg .stat-icon.primary { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .stat-card-lg .stat-icon.success { background: linear-gradient(135deg, #10b981, #059669); }
        .stat-card-lg .stat-icon.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .stat-card-lg .stat-icon.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .stat-card-lg .stat-content { flex: 1; }
        .stat-card-lg .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); display: block; }
        .stat-card-lg .stat-label { font-size: 0.875rem; color: var(--text-secondary); }
        .stat-card-lg .stat-change { font-size: 0.75rem; margin-top: 0.25rem; }
        .stat-card-lg .stat-change.positive { color: #10b981; }
        .stat-card-lg .stat-change.negative { color: #ef4444; }
        
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .chart-card { background: var(--bg-card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border-color); }
        .chart-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .chart-container { position: relative; height: 300px; }
        
        .alerts-section { margin-bottom: 1.5rem; }
        .alert-card { background: var(--bg-card); border-radius: 12px; padding: 1rem 1.5rem; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; border-right: 4px solid; }
        .alert-card.danger { border-right-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .alert-card.warning { border-right-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .alert-card.info { border-right-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .alert-card .alert-icon { font-size: 1.5rem; }
        .alert-card .alert-content { flex: 1; }
        .alert-card .alert-title { font-weight: 600; color: var(--text-primary); }
        .alert-card .alert-desc { font-size: 0.875rem; color: var(--text-secondary); }
        
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; }
        .list-card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color); }
        .list-card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .list-card-header h3 { font-size: 1rem; font-weight: 600; margin: 0; color: var(--text-primary); }
        .list-card-body { padding: 0; max-height: 300px; overflow-y: auto; }
        .list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; text-decoration: none; color: var(--text-primary); }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: var(--bg-tertiary); }
        .list-item-title { font-weight: 500; color: var(--text-primary); }
        .list-item-subtitle { font-size: 0.75rem; color: var(--text-muted); }
        
        .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .quick-action-btn { background: var(--bg-card); border: 2px dashed var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: var(--text-primary); transition: all 0.2s; }
        .quick-action-btn:hover { border-color: var(--accent); background: var(--accent-light); }
        .quick-action-btn .icon { font-size: 2rem; margin-bottom: 0.5rem; display: block; }
        .quick-action-btn span { font-weight: 500; color: var(--text-primary); }

        @media (max-width: 1200px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .bottom-grid { grid-template-columns: 1fr; }
            .quick-actions { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .quick-actions { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="header" id="header">
                <div class="header-left">
                    <h1 class="page-title">لوحة التحكم</h1>
                </div>
                <div class="header-right">
                    <span id="currentDate" style="color: var(--text-muted); font-size: 0.875rem;"></span>
                </div>
            </header>

            <div class="page-content">
                <!-- Alerts Section -->
                <div class="alerts-section" id="alertsSection"></div>

                <!-- Main Stats -->
                <div class="dashboard-grid">
                    <div class="stat-card-lg">
                        <div class="stat-icon primary">💰</div>
                        <div class="stat-content">
                            <span class="stat-value" id="todayRevenue">0 ج.م</span>
                            <span class="stat-label">إيرادات اليوم</span>
                            <div class="stat-change positive" id="revenueChange">↑ 0%</div>
                        </div>
                    </div>
                    <div class="stat-card-lg">
                        <div class="stat-icon info">🔧</div>
                        <div class="stat-content">
                            <span class="stat-value" id="activeWorkOrders">0</span>
                            <span class="stat-label">أوامر شغل نشطة</span>
                            <div class="stat-change" id="woChange">قيد التنفيذ</div>
                        </div>
                    </div>
                    <div class="stat-card-lg">
                        <div class="stat-icon success">👥</div>
                        <div class="stat-content">
                            <span class="stat-value" id="totalCustomers">0</span>
                            <span class="stat-label">إجمالي العملاء</span>
                            <div class="stat-change positive" id="customersChange">↑ 0 هذا الشهر</div>
                        </div>
                    </div>
                    <div class="stat-card-lg">
                        <div class="stat-icon danger">📦</div>
                        <div class="stat-content">
                            <span class="stat-value" id="lowStockCount">0</span>
                            <span class="stat-label">قطع تحتاج توريد</span>
                            <div class="stat-change negative">⚠️ تنبيه</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <a href="pages/quotations/form.html" class="quick-action-btn">
                        <span class="icon">📝</span>
                        <span>مقايسة جديدة</span>
                    </a>
                    <a href="pages/workorders/form.html" class="quick-action-btn">
                        <span class="icon">🔧</span>
                        <span>أمر شغل جديد</span>
                    </a>
                    <a href="pages/customers/form.html" class="quick-action-btn">
                        <span class="icon">👤</span>
                        <span>عميل جديد</span>
                    </a>
                    <a href="pages/inventory/form.html" class="quick-action-btn">
                        <span class="icon">📦</span>
                        <span>إضافة قطعة غيار</span>
                    </a>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>📊 إيرادات آخر 7 أيام</h3>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>📈 حالة أوامر الشغل</h3>
                        <div class="chart-container">
                            <canvas id="workOrdersChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="bottom-grid">
                    <!-- Recent Work Orders -->
                    <div class="list-card">
                        <div class="list-card-header">
                            <h3>🔧 أوامر الشغل الأخيرة</h3>
                            <a href="pages/workorders/list.html" class="btn btn-sm btn-ghost">عرض الكل</a>
                        </div>
                        <div class="list-card-body" id="recentWorkOrders">
                            <div class="list-item"><span class="text-muted">جاري التحميل...</span></div>
                        </div>
                    </div>

                    <!-- Recent Invoices -->
                    <div class="list-card">
                        <div class="list-card-header">
                            <h3>🧾 أحدث الفواتير</h3>
                            <a href="pages/invoices/list.html" class="btn btn-sm btn-ghost">عرض الكل</a>
                        </div>
                        <div class="list-card-body" id="recentInvoices">
                            <div class="list-item"><span class="text-muted">جاري التحميل...</span></div>
                        </div>
                    </div>

                    <!-- Low Stock Items -->
                    <div class="list-card">
                        <div class="list-card-header">
                            <h3>⚠️ مخزون منخفض</h3>
                            <a href="pages/inventory/list.html" class="btn btn-sm btn-ghost">عرض الكل</a>
                        </div>
                        <div class="list-card-body" id="lowStockItems">
                            <div class="list-item"><span class="text-muted">جاري التحميل...</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../assets/js/utils/numbers.js"></script>
    <script src="assets/js/i18n/ar.js"></script>
    <script src="assets/js/i18n/en.js"></script>
    <script src="assets/js/i18n/i18n.js"></script>
    <script src="assets/js/config/supabase.js"></script>
    <script src="assets/js/auth/auth.js"></script>
    <script src="assets/js/utils/ui.js"></script>
    <script src="assets/js/components/sidebar.js"></script>

    <script>
        let revenueChart, workOrdersChart;

        async function init() {
            i18n.init();
            const { session, user } = await auth.init();
            if (!session) { window.location.href = 'index.html'; return; }
            Sidebar.render(user);
            
            // Set current date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Load all dashboard data
            await Promise.all([
                loadStats(),
                loadAlerts(),
                loadRevenueChart(),
                loadWorkOrdersChart(),
                loadRecentWorkOrders(),
                loadRecentInvoices(),
                loadLowStockItems()
            ]);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG').format(amount || 0) + ' ج.م';
        }

        // Load main statistics
        async function loadStats() {
            try {
                // Today's revenue
                const today = new Date().toISOString().split('T')[0];
                const { data: todayPayments } = await db.from('payments').select('amount').gte('created_at', today + 'T00:00:00');
                const todayRevenue = (todayPayments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                document.getElementById('todayRevenue').textContent = formatCurrency(todayRevenue);

                // Yesterday's revenue for comparison
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                const { data: yesterdayPayments } = await db.from('payments').select('amount').gte('created_at', yesterday + 'T00:00:00').lt('created_at', today + 'T00:00:00');
                const yesterdayRevenue = (yesterdayPayments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                
                if (yesterdayRevenue > 0) {
                    const change = ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100).toFixed(0);
                    document.getElementById('revenueChange').textContent = change >= 0 ? `↑ ${change}%` : `↓ ${Math.abs(change)}%`;
                    document.getElementById('revenueChange').className = 'stat-change ' + (change >= 0 ? 'positive' : 'negative');
                }

                // Active work orders
                const { count: activeWO } = await db.from('work_orders').select('*', { count: 'exact', head: true }).in('status', ['pending', 'in_progress']);
                document.getElementById('activeWorkOrders').textContent = activeWO || 0;

                // Total customers
                const { count: totalCustomers } = await db.from('customers').select('*', { count: 'exact', head: true });
                document.getElementById('totalCustomers').textContent = totalCustomers || 0;

                // New customers this month
                const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
                const { count: newCustomers } = await db.from('customers').select('*', { count: 'exact', head: true }).gte('created_at', monthStart);
                document.getElementById('customersChange').textContent = `↑ ${newCustomers || 0} هذا الشهر`;

                // Low stock count
                const { data: lowStock } = await db.from('inventory').select('quantity, parts(min_quantity)').lt('quantity', 10);
                const lowStockCount = (lowStock || []).filter(i => i.quantity <= (i.parts?.min_quantity || 5)).length;
                document.getElementById('lowStockCount').textContent = lowStockCount;

            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        // Load alerts
        async function loadAlerts() {
            const alerts = [];
            
            try {
                // Check low stock
                const { data: lowStock } = await db.from('inventory').select('*, parts(name, min_quantity)').lt('quantity', 10);
                const criticalStock = (lowStock || []).filter(i => i.quantity <= (i.parts?.min_quantity || 5));
                
                if (criticalStock.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: '⚠️',
                        title: `${criticalStock.length} قطع غيار تحتاج توريد عاجل`,
                        desc: 'المخزون وصل للحد الأدنى',
                        action: { text: 'عرض', href: 'pages/inventory/list.html' }
                    });
                }

                // Check pending work orders
                const { count: pendingWO } = await db.from('work_orders').select('*', { count: 'exact', head: true }).eq('status', 'pending');
                if (pendingWO > 0) {
                    alerts.push({
                        type: 'warning',
                        icon: '📋',
                        title: `${pendingWO} أوامر شغل في الانتظار`,
                        desc: 'تحتاج للبدء في التنفيذ',
                        action: { text: 'عرض', href: 'pages/workorders/list.html?status=pending' }
                    });
                }

                // Check unpaid invoices
                const { count: unpaidInv } = await db.from('invoices').select('*', { count: 'exact', head: true }).in('status', ['issued', 'partial']);
                if (unpaidInv > 0) {
                    alerts.push({
                        type: 'info',
                        icon: '💳',
                        title: `${unpaidInv} فواتير غير مدفوعة`,
                        desc: 'تحتاج متابعة التحصيل',
                        action: { text: 'عرض', href: 'pages/invoices/list.html' }
                    });
                }

            } catch (error) {
                console.error('Alerts error:', error);
            }

            const container = document.getElementById('alertsSection');
            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = alerts.map(a => `
                <div class="alert-card ${a.type}">
                    <span class="alert-icon">${a.icon}</span>
                    <div class="alert-content">
                        <div class="alert-title">${a.title}</div>
                        <div class="alert-desc">${a.desc}</div>
                    </div>
                    <a href="${a.action.href}" class="btn btn-sm btn-${a.type === 'danger' ? 'danger' : 'primary'}">${a.action.text}</a>
                </div>
            `).join('');
        }

        // Revenue Chart - Last 7 days
        async function loadRevenueChart() {
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 86400000);
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('ar-EG', { weekday: 'short' }));
                
                try {
                    const { data: payments } = await db.from('payments').select('amount').gte('created_at', dateStr + 'T00:00:00').lt('created_at', dateStr + 'T23:59:59');
                    const total = (payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                    data.push(total);
                } catch {
                    data.push(0);
                }
            }

            const ctx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'الإيرادات',
                        data,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { 
                                callback: v => v.toLocaleString() + ' ج.م',
                                color: '#94a3b8'
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }

        // Work Orders Status Chart
        async function loadWorkOrdersChart() {
            const statuses = [
                { key: 'pending', label: 'في الانتظار', color: '#f59e0b' },
                { key: 'in_progress', label: 'قيد التنفيذ', color: '#3b82f6' },
                { key: 'completed', label: 'مكتمل', color: '#10b981' },
                { key: 'delivered', label: 'تم التسليم', color: '#6b7280' }
            ];

            const data = [];
            for (const s of statuses) {
                const { count } = await db.from('work_orders').select('*', { count: 'exact', head: true }).eq('status', s.key);
                data.push(count || 0);
            }

            const ctx = document.getElementById('workOrdersChart').getContext('2d');
            workOrdersChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: statuses.map(s => s.label),
                    datasets: [{
                        data,
                        backgroundColor: statuses.map(s => s.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                padding: 20, 
                                usePointStyle: true,
                                color: '#f8fafc'
                            } 
                        }
                    }
                }
            });
        }

        // Recent Work Orders
        async function loadRecentWorkOrders() {
            try {
                const { data } = await db.from('work_orders').select('id, order_number, status, total, customers(name)').order('created_at', { ascending: false }).limit(5);
                
                const container = document.getElementById('recentWorkOrders');
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="list-item"><span class="text-muted">لا توجد أوامر شغل</span></div>';
                    return;
                }

                const statusMap = { pending: 'في الانتظار', in_progress: 'قيد التنفيذ', completed: 'مكتمل', delivered: 'تم التسليم' };
                container.innerHTML = data.map(wo => `
                    <a href="pages/workorders/view.html?id=${wo.id}" class="list-item">
                        <div>
                            <div class="list-item-title">${wo.order_number}</div>
                            <div class="list-item-subtitle">${wo.customers?.name || '-'}</div>
                        </div>
                        <span class="badge badge-sm">${statusMap[wo.status] || wo.status}</span>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Recent WO error:', error);
            }
        }

        // Recent Invoices
        async function loadRecentInvoices() {
            try {
                const { data } = await db.from('invoices').select('id, invoice_number, total, status, customers(name)').order('created_at', { ascending: false }).limit(5);
                
                const container = document.getElementById('recentInvoices');
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="list-item"><span class="text-muted">لا توجد فواتير</span></div>';
                    return;
                }

                container.innerHTML = data.map(inv => `
                    <a href="pages/invoices/view.html?id=${inv.id}" class="list-item">
                        <div>
                            <div class="list-item-title">${inv.invoice_number}</div>
                            <div class="list-item-subtitle">${inv.customers?.name || '-'}</div>
                        </div>
                        <span class="font-semibold">${formatCurrency(inv.total)}</span>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Recent invoices error:', error);
            }
        }

        // Low Stock Items
        async function loadLowStockItems() {
            try {
                const { data } = await db.from('inventory').select('quantity, parts(id, name, sku, min_quantity)').lt('quantity', 10).limit(5);
                
                const container = document.getElementById('lowStockItems');
                const lowItems = (data || []).filter(i => i.quantity <= (i.parts?.min_quantity || 5));
                
                if (lowItems.length === 0) {
                    container.innerHTML = '<div class="list-item"><span class="text-success">✅ المخزون جيد</span></div>';
                    return;
                }

                container.innerHTML = lowItems.map(item => `
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${item.parts?.name || '-'}</div>
                            <div class="list-item-subtitle">${item.parts?.sku || ''}</div>
                        </div>
                        <span class="badge badge-danger">${item.quantity} متبقي</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Low stock error:', error);
            }
        }

        init();
    </script>
</body>

</html>
