<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HiveDrive - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/variables.css">
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/rtl.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card-lg { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 1rem; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card-lg:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .stat-card-lg .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; }
        .stat-card-lg .stat-icon.primary { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .stat-card-lg .stat-icon.success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .stat-card-lg .stat-icon.info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .stat-card-lg .stat-icon.danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .stat-card-lg .stat-icon.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .stat-card-lg .stat-content { flex: 1; }
        .stat-card-lg .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); display: block; }
        .stat-card-lg .stat-label { font-size: 0.875rem; color: var(--text-muted); }
        .stat-card-lg .stat-change { font-size: 0.75rem; margin-top: 0.25rem; display: flex; align-items: center; gap: 0.25rem; }
        .stat-card-lg .stat-change.positive { color: #10b981; }
        .stat-card-lg .stat-change.negative { color: #ef4444; }
        
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .chart-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .chart-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
        .chart-container { position: relative; height: 300px; }
        
        .alerts-section { margin-bottom: 1.5rem; }
        .alert-card { background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; border-right: 4px solid; }
        .alert-card.danger { border-color: #ef4444; background: #fef2f2; }
        .alert-card.warning { border-color: #f59e0b; background: #fffbeb; }
        .alert-card.info { border-color: #3b82f6; background: #eff6ff; }
        .alert-card .alert-icon { font-size: 1.5rem; }
        .alert-card .alert-content { flex: 1; }
        .alert-card .alert-title { font-weight: 600; color: var(--text-primary); }
        .alert-card .alert-desc { font-size: 0.875rem; color: var(--text-muted); }
        .alert-card .alert-action { }
        
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; }
        .list-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .list-card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .list-card-header h3 { font-size: 1rem; font-weight: 600; margin: 0; }
        .list-card-body { padding: 0; max-height: 300px; overflow-y: auto; }
        .list-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: var(--bg-secondary); }
        .list-item-title { font-weight: 500; }
        .list-item-subtitle { font-size: 0.75rem; color: var(--text-muted); }
        
        .quick-actions { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .quick-action-btn { background: white; border: 2px dashed var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; text-decoration: none; color: var(--text-primary); transition: all 0.2s; }
        .quick-action-btn:hover { border-color: var(--primary); background: var(--primary-50); }
        .quick-action-btn .icon { font-size: 2rem; margin-bottom: 0.5rem; display: block; }
        .quick-action-btn span { font-weight: 500; }

        @media (max-width: 1200px) {
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .bottom-grid { grid-template-columns: 1fr; }
            .quick-actions { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .quick-actions { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>
        <main class="main-content">
            <header class="header" id="header">
                <div class="header-left">
                    <button class="btn btn-icon btn-ghost" id="mobileMenuBtn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="3" y1="12" x2="21" y2="12" /><line x1="3" y1="6" x2="21" y2="6" /><line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                    <h1 class="page-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                </div>
                <div class="header-right">
                    <span id="currentDate" style="color: var(--text-muted); font-size: 0.875rem;"></span>
                </div>
            </header>

            <div class="page-content">
                <!-- Alerts Section -->
                <div class="alerts-section" id="alertsSection"></div>

                <!-- Main Stats -->
                <div class="dashboard-grid">
                    <div class="stat-card-lg">
                        <div class="stat-icon primary">ğŸ’°</div>
                        <div class="stat-content">
                            <span class="stat-value" id="todayRevenue">0 Ø¬.Ù…</span>
                            <span class="stat-label">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
                            <div class="stat-change positive" id="revenueChange">â†‘ 0%</div>
                        </div>
                    </div>
                    <div class="stat-card-lg">
                        <div class="stat-icon info">ğŸ”§</div>
                        <div class="stat-content">
                            <span class="stat-value" id="activeWorkOrders">0</span>
                            <span class="stat-label">Ø£ÙˆØ§Ù…Ø± Ø´ØºÙ„ Ù†Ø´Ø·Ø©</span>
                            <div class="stat-change" id="woChange">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                        </div>
                    </div>
                    <div class="stat-card-lg">
                        <div class="stat-icon success">ğŸ‘¥</div>
                        <div class="stat-content">
                            <span class="stat-value" id="totalCustomers">0</span>
                            <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
                            <div class="stat-change positive" id="customersChange">â†‘ 0 Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
                        </div>
                    </div>
                    <div class="stat-card-lg">
                        <div class="stat-icon danger">ğŸ“¦</div>
                        <div class="stat-content">
                            <span class="stat-value" id="lowStockCount">0</span>
                            <span class="stat-label">Ù‚Ø·Ø¹ ØªØ­ØªØ§Ø¬ ØªÙˆØ±ÙŠØ¯</span>
                            <div class="stat-change negative">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <a href="pages/quotations/form.html" class="quick-action-btn">
                        <span class="icon">ğŸ“</span>
                        <span>Ù…Ù‚Ø§ÙŠØ³Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
                    </a>
                    <a href="pages/workorders/form.html" class="quick-action-btn">
                        <span class="icon">ğŸ”§</span>
                        <span>Ø£Ù…Ø± Ø´ØºÙ„ Ø¬Ø¯ÙŠØ¯</span>
                    </a>
                    <a href="pages/customers/form.html" class="quick-action-btn">
                        <span class="icon">ğŸ‘¤</span>
                        <span>Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</span>
                    </a>
                    <a href="pages/inventory/form.html" class="quick-action-btn">
                        <span class="icon">ğŸ“¦</span>
                        <span>Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø¹Ø© ØºÙŠØ§Ø±</span>
                    </a>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>ğŸ“Š Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</h3>
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>ğŸ“ˆ Ø­Ø§Ù„Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„</h3>
                        <div class="chart-container">
                            <canvas id="workOrdersChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="bottom-grid">
                    <!-- Recent Work Orders -->
                    <div class="list-card">
                        <div class="list-card-header">
                            <h3>ğŸ”§ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ØºÙ„ Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
                            <a href="pages/workorders/list.html" class="btn btn-sm btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div class="list-card-body" id="recentWorkOrders">
                            <div class="list-item"><span class="text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
                        </div>
                    </div>

                    <!-- Recent Invoices -->
                    <div class="list-card">
                        <div class="list-card-header">
                            <h3>ğŸ§¾ Ø£Ø­Ø¯Ø« Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
                            <a href="pages/invoices/list.html" class="btn btn-sm btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div class="list-card-body" id="recentInvoices">
                            <div class="list-item"><span class="text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
                        </div>
                    </div>

                    <!-- Low Stock Items -->
                    <div class="list-card">
                        <div class="list-card-header">
                            <h3>âš ï¸ Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶</h3>
                            <a href="pages/inventory/list.html" class="btn btn-sm btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div class="list-card-body" id="lowStockItems">
                            <div class="list-item"><span class="text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/i18n/ar.js"></script>
    <script src="assets/js/i18n/en.js"></script>
    <script src="assets/js/i18n/i18n.js"></script>
    <script src="assets/js/config/supabase.js"></script>
    <script src="assets/js/auth/auth.js"></script>
    <script src="assets/js/utils/ui.js"></script>
    <script src="assets/js/components/sidebar.js"></script>

    <script>
        let revenueChart, workOrdersChart;

        async function init() {
            i18n.init();
            const { session, user } = await auth.init();
            if (!session) { window.location.href = 'index.html'; return; }
            Sidebar.render(user);
            
            // Set current date
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Load all dashboard data
            await Promise.all([
                loadStats(),
                loadAlerts(),
                loadRevenueChart(),
                loadWorkOrdersChart(),
                loadRecentWorkOrders(),
                loadRecentInvoices(),
                loadLowStockItems()
            ]);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG').format(amount || 0) + ' Ø¬.Ù…';
        }

        // Load main statistics
        async function loadStats() {
            try {
                // Today's revenue
                const today = new Date().toISOString().split('T')[0];
                const { data: todayPayments } = await db.from('payments').select('amount').gte('created_at', today + 'T00:00:00');
                const todayRevenue = (todayPayments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                document.getElementById('todayRevenue').textContent = formatCurrency(todayRevenue);

                // Yesterday's revenue for comparison
                const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                const { data: yesterdayPayments } = await db.from('payments').select('amount').gte('created_at', yesterday + 'T00:00:00').lt('created_at', today + 'T00:00:00');
                const yesterdayRevenue = (yesterdayPayments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                
                if (yesterdayRevenue > 0) {
                    const change = ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100).toFixed(0);
                    document.getElementById('revenueChange').textContent = change >= 0 ? `â†‘ ${change}%` : `â†“ ${Math.abs(change)}%`;
                    document.getElementById('revenueChange').className = 'stat-change ' + (change >= 0 ? 'positive' : 'negative');
                }

                // Active work orders
                const { count: activeWO } = await db.from('work_orders').select('*', { count: 'exact', head: true }).in('status', ['pending', 'in_progress']);
                document.getElementById('activeWorkOrders').textContent = activeWO || 0;

                // Total customers
                const { count: totalCustomers } = await db.from('customers').select('*', { count: 'exact', head: true });
                document.getElementById('totalCustomers').textContent = totalCustomers || 0;

                // New customers this month
                const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
                const { count: newCustomers } = await db.from('customers').select('*', { count: 'exact', head: true }).gte('created_at', monthStart);
                document.getElementById('customersChange').textContent = `â†‘ ${newCustomers || 0} Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±`;

                // Low stock count
                const { data: lowStock } = await db.from('inventory').select('quantity, parts(min_quantity)').lt('quantity', 10);
                const lowStockCount = (lowStock || []).filter(i => i.quantity <= (i.parts?.min_quantity || 5)).length;
                document.getElementById('lowStockCount').textContent = lowStockCount;

            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        // Load alerts
        async function loadAlerts() {
            const alerts = [];
            
            try {
                // Check low stock
                const { data: lowStock } = await db.from('inventory').select('*, parts(name, min_quantity)').lt('quantity', 10);
                const criticalStock = (lowStock || []).filter(i => i.quantity <= (i.parts?.min_quantity || 5));
                
                if (criticalStock.length > 0) {
                    alerts.push({
                        type: 'danger',
                        icon: 'âš ï¸',
                        title: `${criticalStock.length} Ù‚Ø·Ø¹ ØºÙŠØ§Ø± ØªØ­ØªØ§Ø¬ ØªÙˆØ±ÙŠØ¯ Ø¹Ø§Ø¬Ù„`,
                        desc: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰',
                        action: { text: 'Ø¹Ø±Ø¶', href: 'pages/inventory/list.html' }
                    });
                }

                // Check pending work orders
                const { count: pendingWO } = await db.from('work_orders').select('*', { count: 'exact', head: true }).eq('status', 'pending');
                if (pendingWO > 0) {
                    alerts.push({
                        type: 'warning',
                        icon: 'ğŸ“‹',
                        title: `${pendingWO} Ø£ÙˆØ§Ù…Ø± Ø´ØºÙ„ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±`,
                        desc: 'ØªØ­ØªØ§Ø¬ Ù„Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°',
                        action: { text: 'Ø¹Ø±Ø¶', href: 'pages/workorders/list.html?status=pending' }
                    });
                }

                // Check unpaid invoices
                const { count: unpaidInv } = await db.from('invoices').select('*', { count: 'exact', head: true }).in('status', ['issued', 'partial']);
                if (unpaidInv > 0) {
                    alerts.push({
                        type: 'info',
                        icon: 'ğŸ’³',
                        title: `${unpaidInv} ÙÙˆØ§ØªÙŠØ± ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©`,
                        desc: 'ØªØ­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­ØµÙŠÙ„',
                        action: { text: 'Ø¹Ø±Ø¶', href: 'pages/invoices/list.html' }
                    });
                }

            } catch (error) {
                console.error('Alerts error:', error);
            }

            const container = document.getElementById('alertsSection');
            if (alerts.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = alerts.map(a => `
                <div class="alert-card ${a.type}">
                    <span class="alert-icon">${a.icon}</span>
                    <div class="alert-content">
                        <div class="alert-title">${a.title}</div>
                        <div class="alert-desc">${a.desc}</div>
                    </div>
                    <a href="${a.action.href}" class="btn btn-sm btn-${a.type === 'danger' ? 'danger' : 'primary'}">${a.action.text}</a>
                </div>
            `).join('');
        }

        // Revenue Chart - Last 7 days
        async function loadRevenueChart() {
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 86400000);
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('ar-EG', { weekday: 'short' }));
                
                try {
                    const { data: payments } = await db.from('payments').select('amount').gte('created_at', dateStr + 'T00:00:00').lt('created_at', dateStr + 'T23:59:59');
                    const total = (payments || []).reduce((sum, p) => sum + (p.amount || 0), 0);
                    data.push(total);
                } catch {
                    data.push(0);
                }
            }

            const ctx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',
                        data,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#f59e0b',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString() + ' Ø¬.Ù…' } }
                    }
                }
            });
        }

        // Work Orders Status Chart
        async function loadWorkOrdersChart() {
            const statuses = [
                { key: 'pending', label: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', color: '#f59e0b' },
                { key: 'in_progress', label: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', color: '#3b82f6' },
                { key: 'completed', label: 'Ù…ÙƒØªÙ…Ù„', color: '#10b981' },
                { key: 'delivered', label: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', color: '#6b7280' }
            ];

            const data = [];
            for (const s of statuses) {
                const { count } = await db.from('work_orders').select('*', { count: 'exact', head: true }).eq('status', s.key);
                data.push(count || 0);
            }

            const ctx = document.getElementById('workOrdersChart').getContext('2d');
            workOrdersChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: statuses.map(s => s.label),
                    datasets: [{
                        data,
                        backgroundColor: statuses.map(s => s.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }
                    }
                }
            });
        }

        // Recent Work Orders
        async function loadRecentWorkOrders() {
            try {
                const { data } = await db.from('work_orders').select('id, order_number, status, total, customers(name)').order('created_at', { ascending: false }).limit(5);
                
                const container = document.getElementById('recentWorkOrders');
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="list-item"><span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ø´ØºÙ„</span></div>';
                    return;
                }

                const statusMap = { pending: 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', in_progress: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°', completed: 'Ù…ÙƒØªÙ…Ù„', delivered: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' };
                container.innerHTML = data.map(wo => `
                    <a href="pages/workorders/view.html?id=${wo.id}" class="list-item">
                        <div>
                            <div class="list-item-title">${wo.order_number}</div>
                            <div class="list-item-subtitle">${wo.customers?.name || '-'}</div>
                        </div>
                        <span class="badge badge-sm">${statusMap[wo.status] || wo.status}</span>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Recent WO error:', error);
            }
        }

        // Recent Invoices
        async function loadRecentInvoices() {
            try {
                const { data } = await db.from('invoices').select('id, invoice_number, total, status, customers(name)').order('created_at', { ascending: false }).limit(5);
                
                const container = document.getElementById('recentInvoices');
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="list-item"><span class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</span></div>';
                    return;
                }

                container.innerHTML = data.map(inv => `
                    <a href="pages/invoices/view.html?id=${inv.id}" class="list-item">
                        <div>
                            <div class="list-item-title">${inv.invoice_number}</div>
                            <div class="list-item-subtitle">${inv.customers?.name || '-'}</div>
                        </div>
                        <span class="font-semibold">${formatCurrency(inv.total)}</span>
                    </a>
                `).join('');
            } catch (error) {
                console.error('Recent invoices error:', error);
            }
        }

        // Low Stock Items
        async function loadLowStockItems() {
            try {
                const { data } = await db.from('inventory').select('quantity, parts(id, name, sku, min_quantity)').lt('quantity', 10).limit(5);
                
                const container = document.getElementById('lowStockItems');
                const lowItems = (data || []).filter(i => i.quantity <= (i.parts?.min_quantity || 5));
                
                if (lowItems.length === 0) {
                    container.innerHTML = '<div class="list-item"><span class="text-success">âœ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¬ÙŠØ¯</span></div>';
                    return;
                }

                container.innerHTML = lowItems.map(item => `
                    <div class="list-item">
                        <div>
                            <div class="list-item-title">${item.parts?.name || '-'}</div>
                            <div class="list-item-subtitle">${item.parts?.sku || ''}</div>
                        </div>
                        <span class="badge badge-danger">${item.quantity} Ù…ØªØ¨Ù‚ÙŠ</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Low stock error:', error);
            }
        }

        // Mobile menu
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });

        init();
    </script>
</body>

</html>
